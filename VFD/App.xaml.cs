using System.IO;
using System.Reflection;
using Monokot.Hmi.Core.Framework.Storage;
using Monokot.ScadaExtension.Wpf.Controls;
using Newtonsoft.Json;
using System;
using System.Linq;
using Monokot.Hmi.StdProviders.Modbus;
using Monokot.Hmi.Core.Tags;
using Monokot.Hmi.Core.Framework.Trees;
using Monokot.Hmi.Core.Utils;
using Monokot.Hmi.Core.Fundamental;
using System.Collections.Generic;
using System.Text;
using NGO.Elements.Special.IO;
using Monokot.Hmi.Core.Utils.Log;
using Monokot.ScadaExtension.Opc.Da;
using System.Collections.ObjectModel;
using System.Windows.Controls;
using System.Windows;
using System.Windows.Data;
using Monokot.Hmi.Core.Framework.Runtime;
using Monokot.ScadaExtension.WpfComponents.Navigation;
using Monokot.ScadaExtension.Wpf.VisualStateCollection.VisualBox;
using Monokot.Hmi.Core.Messages;
using Monokot.Hmi.Core.Common.RPProperties;
using Monokot.ScadaExtension.Wpf.Controls.Buttons;

namespace VFD
{
    public partial class App : SEApplication
    {
        private int DisabledTagsCount = 0;
        private int FastTagsCount = 0;
        private int StrangeTagsCount = 0;
        private int NormalTagsCount = 0;
        private List<HmiTag> FastTags = new List<HmiTag>();

        bool CREATE_TRANSLAYE_DICTIONARY = true;

        private bool S7_PROVIDER_TEST = false;

        private Monokot.Hmi.StdProviders.S7.S7DataProvider s7_provider;

        protected override void OnHmiDataFileLoaded(HmiDataFile file)
        {
            base.OnHmiDataFileLoaded(file);

            //s7_provider = file.DataProvidersModule.DataProvidersRoot.Items["s7_tcp"] as Monokot.Hmi.StdProviders.S7.S7DataProvider;


            var writeNode = file.TagsRoot.Nodes.FirstOrDefault(x => string.Equals(x.ID, "write",
                StringComparison.CurrentCultureIgnoreCase));

            var NodeNamesToDisable = new string[] { "multimetr1", "multimetr2", "bkt1", "kru", "pump3", "write" };

            string ip = string.Empty;
            bool firstlow = false;
            ModbusDataProvider modbus_provider = file.DataProvidersModule.DataProvidersRoot.Items["ModbusDriver"] as ModbusDataProvider;

            var location = Path.GetDirectoryName(Assembly.GetEntryAssembly().Location) + @"\data\ports";
            var ports = GetPorts(location);

            try
            {
                var provider = file.DataProvidersModule.DataProvidersRoot.Items["ModbusDriver"] as ModbusDataProvider;
                ip = provider.Host;
                firstlow = provider.FirstWordLowIn32Bit;
                modbus_provider = provider;
                provider.Port = ports[0];
                //provider.Host = "127.0.0.1";
            }
            catch (Exception ex)
            {

            }

            if (!S7_PROVIDER_TEST)
            {

                var modbus506 = new ModbusDataProvider("modbus_506", file.DataProvidersModule.DataProvidersRoot)
                {
                    Host = ip,
                    Port = ports[1],
                    //Port = 506,
                    //InternalRegistersCount = 64,
                    InternalRegistersCount = 120,
                    FirstWordLowIn32Bit = firstlow
                };

                file.DataProvidersModule.DataProvidersRoot.Items.Add(modbus506);

                var factory = new ModbusDataProviderAddressFactory();

                // nodi dlya otlycheniyta
                HmiUtils.RecursiveNodeAction<TagsHmiNode, string, HmiTag>(file.TagsRoot, n =>
                {
                    if (NodeNamesToDisable.Contains(n.ID))
                    {
                        HmiUtils.RecursiveNodeAction<TagsHmiNode, string, HmiTag>(n, sn =>
                          {
                              foreach (var stag in sn.Items)
                              {
                                  stag.UpdateRate = 0;
                                  DisabledTagsCount++;
                              }


                              foreach (var tag in sn.Items.Where(x =>
                    x.DataProvider != null &&
                    x.DataProvider.GetType() == typeof(OpcDaProvider) &&
                    x.DataAddress != null &&
                    (x.DataAddress.AsString.IndexOf("mb.plc.") != -1 || x.DataAddress.AsString.IndexOf("mb_fast.plc.") != -1)
                    ))
                              {
                                  var opc = tag.DataAddress;
                                  var _short = opc.AsString.Replace("mb.plc.", "").Replace("mb_fast.plc.", "");

                                  if (_short.IndexOf("400") != -1)
                                  {

                                  }

                                  tag.DataProvider = modbus_provider;
                                  tag.DataAddress = factory.ThrowOrParseAddress(_short);
                              }
                          });
                    }
                });

                HmiUtils.RecursiveNodeAction<TagsHmiNode, string, HmiTag>(file.TagsRoot, n =>
            {

                foreach (var item in n.Items)
                {
                    // Legacy of the void 
                    if (
                        item.UpdateRate > 0 &&
                        (item.DataAddress == null || (item.DataAddress.AsString.IndexOf("mb.plc.") == -1 && item.DataAddress.AsString.IndexOf("mb_fast.plc.") == -1) && (item.DataProvider != null && item.DataProvider.GetType() == typeof(OpcDaProvider))))
                    {
                        item.UpdateRate = 0;
                        StrangeTagsCount++;
                    }
                }

                foreach (var tag in n.Items.Where(x =>
                    x.DataProvider != null &&
                    x.UpdateRate > 0 &&
                    x.DataProvider.GetType() == typeof(OpcDaProvider) &&
                    x.DataAddress != null &&
                    (x.DataAddress.AsString.IndexOf("mb.plc.") != -1 || x.DataAddress.AsString.IndexOf("mb_fast.plc.") != -1)
                    ))
                {
                    var opc = tag.DataAddress;
                    var _short = opc.AsString.Replace("mb.plc.", "").Replace("mb_fast.plc.", "");

                    tag.DataAddress = factory.ThrowOrParseAddress(_short);

                    if (tag.UpdateRate <= 200)
                    {
                        tag.DataProvider = modbus506;
                        tag.UpdateRate = 200;
                        FastTagsCount++;
                        FastTags.Add(tag);
                    }

                    else
                    {
                        tag.DataProvider = modbus_provider;
                        NormalTagsCount++;
                    }
                }
            });
            }

            #region S7_PROVIDER_TEST
            //if (S7_PROVIDER_TEST)
            //{
            //    var s7_factory = new Monokot.Hmi.StdProviders.S7.S7DataProviderAddressFactory();

            //    HmiUtils.RecursiveNodeAction<TagsHmiNode, string, HmiTag>(file.TagsRoot, n =>
            //    {
            //        if (writeNode != null)
            //        {
            //            if (HmiUtils.IsSubNodeOf<TagsHmiNode, string, HmiTag>(writeNode, n))
            //            {
            //                foreach (var tag in n.Items)
            //                {
            //                    tag.UpdateRate = 0;
            //                    DisabledTagsCount++;
            //                }
            //            }
            //        }


            //        if (NodeNamesToDisable.Contains(n.ID))
            //        {
            //            // esli est spisok nod kotorue nujno otkluchit
            //            // to jbhodim ih subnodi
            //            foreach (var node in n.Nodes)
            //            {
            //                HmiUtils.RecursiveNodeAction<TagsHmiNode, string, HmiTag>(node, sn =>
            //                {
            //                    if (HmiUtils.IsSubNodeOf<TagsHmiNode, string, HmiTag>(node, sn))
            //                    {
            //                        foreach (var tag in n.Items)
            //                        {
            //                            tag.UpdateRate = 0;
            //                            DisabledTagsCount++;

            //                        }
            //                    }
            //                });
            //            }

            //            foreach (var tag in n.Items)
            //            {
            //                tag.UpdateRate = 0;
            //                DisabledTagsCount++;
            //            }
            //        }
            //        foreach (var tag in n.Items.Where(x => x.DataProvider != null
            //                                            && x.DataProvider.GetType() == typeof(OpcDaProvider)
            //                                            && x.DataAddress != null
            //                                            && (x.DataAddress.AsString.IndexOf("mb.plc.") != -1 || x.DataAddress.AsString.IndexOf("mb_fast.plc.") != -1)))
            //        {
            //            tag.DataProvider = s7_provider;

            //            var s7_address = new Monokot.Hmi.StdProviders.S7.S7DataAddress() { Area = Monokot.Hmi.StdProviders.S7.Common.S7MemoryType.DB };

            //            var address = tag.DataAddress as OpcDaDataAddress;


            //            if (address != null)
            //            {
            //                var _short = address.AsString.Replace("mb.plc.", "").Replace("mb_fast.plc.", "");

            //                if (_short.First() == '3')
            //                {
            //                    s7_address.AreaNumber = 350;
            //                    s7_address.StartAddress = (ushort)((int.Parse((_short.Split('.')[0]).Split('@')[0]) - 300001) * 2);
            //                }

            //                if (_short.First() == '4')
            //                {
            //                    s7_address.AreaNumber = 351;
            //                    s7_address.StartAddress = (ushort)((int.Parse((_short.Split('.')[0]).Split('@')[0]) - 400001) * 2);
            //                }


            //                if (_short.IndexOf("@Short") != -1)
            //                    s7_address.DataType = Monokot.Hmi.StdProviders.S7.Common.S7DataAddressTable.S7IntDataType;

            //                if (_short.IndexOf("@Float") != -1)
            //                    s7_address.DataType = Monokot.Hmi.StdProviders.S7.Common.S7DataAddressTable.S7RealDataType;

            //                if (_short.IndexOf(".") != -1)
            //                {
            //                    try
            //                    {
            //                        s7_address.DataType = Monokot.Hmi.StdProviders.S7.Common.S7DataAddressTable.S7BitType;

            //                        var bit = ushort.Parse(_short.Split('.')[1]);
            //                        var _byte = _short.Split('.')[0];

            //                        if (bit > 7)
            //                        {
            //                            s7_address.BitIndex = (ushort)(bit - 8);
            //                            s7_address.IsBitElement = true;
            //                        }

            //                        if (bit <= 7)
            //                        {
            //                            s7_address.StartAddress = (ushort)(s7_address.StartAddress + 1);
            //                            s7_address.BitIndex = bit;
            //                            s7_address.IsBitElement = true;
            //                        }
            //                    }

            //                    catch (Exception ex)
            //                    {
            //                        var t1 = 3;
            //                        //ignored
            //                    }
            //                }

            //                try
            //                {
            //                    tag.DataAddress = s7_factory.ThrowOrParseAddress(s7_address.AsString);

            //                }
            //                catch (Exception ex)
            //                {
            //                    var t2 = ex;
            //                }
            //            }
            //        }
            //    });
            //}

            #endregion

            LoadTagsForIO(file);
            LoadTagsForReadies(file);

            var t = DisabledTagsCount;

            InitializeMultilanguageArchive(file);
        }

        private void LoadTagsForIO(HmiDataFile file)
        {
            var uri = new Uri(Assembly.GetExecutingAssembly().GetName().CodeBase);
            var location = Path.GetDirectoryName(Path.GetDirectoryName(uri.LocalPath.ToLower()) + @"\data\io\");

            try
            {
                var dir = Directory.GetDirectories(location);
                foreach (var d in dir)
                {
                    var dinf = new DirectoryInfo(d);
                    createIO(dinf.FullName, file);
                }

            }
            catch (Exception x)
            {
                //
            }

        }

        private const string provider_name = "ModbusDriver";
        private const string io_node_name = "io";
        private const string address_preffix = "";
        private const string float_postffix = "@Float";
        private const string read_node_id = "view";
        private readonly Dictionary<string, HmiTag> _tagsForAdd = new Dictionary<string, HmiTag>();

        public void createIO(string io_files_path, HmiDataFile hmiDataFile)
        {
            var files = Directory.GetFiles(io_files_path);
            var plcModuleType = PLCModuleType.Input;
            var isDiscreteIO = true;
            var descript = "Модуль дискретных входов";

            foreach (var f in files.Select(file => new FileInfo(file)))
            {

                if ((f.Name.IndexOf("AI", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("FM", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("IE", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("VHSC", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("IF", StringComparison.Ordinal) > 0))
                {
                    isDiscreteIO = false;
                    plcModuleType = PLCModuleType.Input;
                    descript = "Модуль аналоговых входов";
                }
                if ((f.Name.IndexOf("DI", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("IB", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("IW", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("IM", StringComparison.Ordinal) > 0))
                {
                    isDiscreteIO = true;
                    plcModuleType = PLCModuleType.Input;
                    descript = "Модуль дискретных входов";
                }
                if ((f.Name.IndexOf("AO", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("EO", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("OE", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("OF", StringComparison.Ordinal) > 0))
                {
                    isDiscreteIO = false;
                    plcModuleType = PLCModuleType.Output;
                    descript = "Модуль аналоговых выходов";
                }
                if ((f.Name.IndexOf("DO", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("OB", StringComparison.Ordinal) > 0) ||
                    (f.Name.IndexOf("OW", St                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   